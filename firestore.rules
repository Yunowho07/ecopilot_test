rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // USERS COLLECTION
    // ========================================
    // Main user profiles with eco points, rank, streak tracking
    match /users/{userId} {
      // Allow authenticated user to read their own profile and any other user profile (for leaderboards)
      allow read: if request.auth != null;
      
      // Allow authenticated user to update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Validate user document structure on create
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll(['name', 'email'])
                    && request.resource.data.ecoPoints is int
                    && request.resource.data.streakCount is int;
      
      // Allow user to delete their own profile
      allow delete: if request.auth != null && request.auth.uid == userId;

      // Point History subcollection: /users/{userId}/point_history/{historyId}
      // Allow all authenticated users to read (for leaderboard calculations)
      // Only allow owner to write
      match /point_history/{historyId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Monthly points subcollection: /users/{userId}/monthly_points/{monthKey}
      // Allow all authenticated users to read for leaderboard calculations
      match /monthly_points/{monthKey} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Scans subcollection: /users/{userId}/scans/{scanId}
      match /scans/{scanId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Disposal scans subcollection: /users/{userId}/disposal_scans/{scanId}
      match /disposal_scans/{scanId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Wishlist subcollection: /users/{userId}/wishlist/{productId}
      match /wishlist/{productId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Redemptions subcollection: /users/{userId}/redemptions/{redemptionId}
      match /redemptions/{redemptionId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // Alternative History subcollection: /users/{userId}/alternative_history/{historyId}
      match /alternative_history/{historyId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ========================================
    // SCANNED PRODUCTS COLLECTION
    // ========================================
    // Products scanned by users (main scan screen)
    match /scanned_products/{productId} {
      // Anyone authenticated can read
      allow read: if request.auth != null;
      // Only the user who scanned can write
      allow write: if request.auth != null 
                   && request.auth.uid == request.resource.data.userId;
      
      // Validate required fields
      allow create: if request.resource.data.keys().hasAll([
        'userId', 'productName', 'ecoScore', 'timestamp'
      ]);
    }

    // ========================================
    // DISPOSAL PRODUCTS COLLECTION
    // ========================================
    // Products scanned for disposal guidance
    match /disposal_products/{disposalId} {
      // Anyone authenticated can read
      allow read: if request.auth != null;
      // Only the user who scanned can write
      allow write: if request.auth != null 
                   && request.auth.uid == request.resource.data.userId;
      
      // Validate required fields
      allow create: if request.resource.data.keys().hasAll([
        'userId', 'productName', 'material', 'howToDispose', 'timestamp'
      ]);
    }

    // ========================================
    // ALTERNATIVE PRODUCTS COLLECTION
    // ========================================
    // Eco-friendly product alternatives
    match /alternative_products/{alternativeId} {
      // Anyone authenticated can read alternatives
      allow read: if request.auth != null;
      // Allow authenticated users to write (for Gemini-generated alternatives)
      allow write: if request.auth != null;
      
      // Validate structure
      allow create: if request.resource.data.keys().hasAll([
        'name', 'ecoScore', 'category'
      ]);
    }

    // ========================================
    // ECO CHALLENGES COLLECTION
    // ========================================
    // Daily eco challenges available to all users
    match /eco_challenges/{challengeId} {
      // All authenticated users can read challenges
      allow read: if request.auth != null;
      // Only admins/cloud functions can create challenges
      allow write: if false;
      
      // Validate challenge structure
      allow create: if request.resource.data.keys().hasAll([
        'title', 'description', 'pointsReward', 'dateAvailable', 'isActive'
      ]);
    }
    
    // Legacy challenges collection (keep for backward compatibility)
    match /challenges/{date} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ========================================
    // USER CHALLENGES COLLECTION
    // ========================================
    // Tracks individual user progress on challenges
    match /user_challenges/{challengeDoc} {
      // Document ID format: {userId}-{date}
      // Allow if the document ID starts with the user's UID
      allow read: if request.auth != null 
                  && challengeDoc.matches('^' + request.auth.uid + '-.*');
      allow write: if request.auth != null 
                   && challengeDoc.matches('^' + request.auth.uid + '-.*');
      
      // Validate structure
      allow create: if request.resource.data.keys().hasAll([
        'userId', 'completed', 'pointsEarned', 'date'
      ]);
    }

    // ========================================
    // ECO POINT HISTORY COLLECTION
    // ========================================
    // Global point history for all users (for leaderboard/analytics)
    match /eco_point_history/{historyId} {
      // Users can read their own history
      allow read: if request.auth != null 
                  && request.auth.uid == resource.data.userId;
      // Only the user can create their own history
      allow write: if request.auth != null 
                   && request.auth.uid == request.resource.data.userId;
      
      // Validate structure
      allow create: if request.resource.data.keys().hasAll([
        'userId', 'source', 'pointsEarned', 'dateEarned'
      ]);
    }

    // ========================================
    // TIPS COLLECTION
    // ========================================
    // Daily eco tips (legacy collection)
    match /tips/{date} {
      allow read: if request.auth != null;
      allow write: if false; // Only admins/cloud functions
    }
    
    // Daily eco tips (new collection)
    match /daily_tips/{date} {
      allow read: if request.auth != null;
      // Allow creating tips if they don't exist (for client-side generation)
      allow create: if request.auth != null;
      // Only admins can update or delete tips
      allow update, delete: if false;
    }

    // ========================================
    // NOTIFICATIONS COLLECTION
    // ========================================
    match /notifications/{notificationId} {
      allow read: if request.auth != null 
                  && request.auth.uid == resource.data.userId;
      allow write: if request.auth != null 
                   && request.auth.uid == request.resource.data.userId;
    }
    
    // User-specific notifications subcollection
    match /users/{userId}/notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User-specific bookmarked tips subcollection
    match /users/{userId}/bookmarked_tips/{tipId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ========================================
    // ALTERNATIVE PRODUCTS COLLECTION
    // ========================================
    // Eco-friendly product alternatives generated by Gemini AI
    match /alternative_products/{productId} {
      // Anyone authenticated can read alternatives
      allow read: if request.auth != null;
      
      // Anyone authenticated can create alternatives (for Gemini caching)
      allow create: if request.auth != null
                    && request.resource.data.keys().hasAll([
                      'name', 'ecoScore', 'category'
                    ]);
      
      // Only allow updates if the alternative doesn't have critical fields locked
      allow update: if request.auth != null;
      
      // Prevent deletion by regular users (only admins via console)
      allow delete: if false;
    }

    // ========================================
    // USER CONTRIBUTIONS COLLECTION
    // ========================================
    // Products contributed by users for barcode not found in databases
    match /user_contributions/{contributionId} {
      // Anyone authenticated can read contributions
      allow read: if request.auth != null;
      
      // Only authenticated users can create contributions
      allow create: if request.auth != null
                    && request.resource.data.keys().hasAll([
                      'barcode', 'productName', 'category', 'contributedBy', 'contributedAt'
                    ])
                    && request.auth.uid == request.resource.data.contributedBy;
      
      // Users can update their own contributions (pending status)
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.contributedBy
                    && resource.data.status == 'pending';
      
      // Prevent deletion by regular users (only admins via console)
      allow delete: if false;
    }

    // ========================================
    // REDEMPTION OFFERS COLLECTION
    // ========================================
    // Redemption offers available to all users
    match /redemption_offers/{offerId} {
      // All authenticated users can read redemption offers
      allow read: if request.auth != null;
      
      // Authenticated users can create/delete offers (for auto-cleanup and reloading)
      allow create, delete: if request.auth != null;
      
      // Only admins can update offers
      allow update: if false;
    }

    // ========================================
    // PUBLIC COLLECTIONS
    // ========================================
    match /public/{doc=**} {
      allow read: if true;
      allow write: if false;
    }

    // ========================================
    // DEFAULT DENY
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

